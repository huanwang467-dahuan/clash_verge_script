// Clash Verge 修复版 v3.0 (修复 Unity 国际版访问与下载)

function main(config) {
  // ====================
  // 1. 核心基础设置
  // ====================
  config['tcp-concurrent'] = true;
  config['unified-delay'] = true;
  config['ipv6'] = false;
  config['log-level'] = 'info';
  config['allow-lan'] = true;
  config['global-client-fingerprint'] = 'chrome';
  
  if (!config['profile']) config['profile'] = {};
  config['profile']['store-selected'] = true;
  config['keep-alive-interval'] = 15;
  config['find-process-mode'] = 'strict';

  // ====================
  // 2. 策略组优化
  // ====================
  const myTolerance = 50;
  // 自动获取第一个策略组的名称（通常是“节点选择”或“Proxy”）
  // 用于后续将 Unity 流量强行指向这个组
  const mainProxyGroup = config['proxy-groups'] && config['proxy-groups'][0] ? config['proxy-groups'][0].name : 'Proxy';

  if (config['proxy-groups'] && Array.isArray(config['proxy-groups'])) {
    config['proxy-groups'].forEach(group => {
      group['lazy'] = true;
      if (['url-test', 'fallback'].includes(group.type)) {
        group['tolerance'] = myTolerance;
        group['url'] = 'http://www.gstatic.com/generate_204';
        group['interval'] = 300;
      }
    });
  }

  // ====================
  // 3. 暴力注入 Unity 规则 (核心修复)
  // ====================
  // 将 Unity 流量强制指向第一个策略组，并不使用 DIRECT
  const unityRules = [
    `DOMAIN-SUFFIX,unity.com,${mainProxyGroup}`,
    `DOMAIN-SUFFIX,unity3d.com,${mainProxyGroup}`,
    `DOMAIN-SUFFIX,unity3d.io,${mainProxyGroup}`,
    `DOMAIN-SUFFIX,packages.unity.com,${mainProxyGroup}`, // 国际版包管理器
    `DOMAIN-SUFFIX,download.unity3d.com,${mainProxyGroup}`, // 国际版下载
    `DOMAIN-SUFFIX,public-cdn.cloud.unity3d.com,${mainProxyGroup}`, // 云资源
    `PROCESS-NAME,Unity Hub.exe,${mainProxyGroup}`, // 强制 Hub 进程走代理
    `PROCESS-NAME,Unity.exe,${mainProxyGroup}`
  ];

  // 将自定义规则插入到规则列表的最前面 (unshift)，确保优先级最高
  if (!config['rules']) config['rules'] = [];
  config['rules'].unshift(...unityRules);


  // ====================
  // 4. DNS 优化 (配合规则)
  // ====================
  const dnsConfig = {
    "enable": true,
    "listen": "0.0.0.0:1053",
    "ipv6": false,
    "use-hosts": true,
    
    // 开启 respect-rules，让上面的规则生效，不进行本地 DNS 解析
    "respect-rules": true, 
    "proxy-server-nameserver": [
      "https://dns.alidns.com/dns-query",
      "https://doh.pub/dns-query"
    ],

    "enhanced-mode": "fake-ip",
    "fake-ip-range": "198.18.0.1/16",
    "fake-ip-filter": [
      "*.lan", "*.local",
      "msftconnecttest.com", "msftncsi.com",
      "stun.*",
      "games.qq.com", "*.games.qq.com",
      // 注意：这里绝对不能把 unity 加入 filter
    ],
    "default-nameserver": [
      "223.5.5.5",
      "119.29.29.29"
    ],
    "nameserver": [
      "223.5.5.5",
      "https://dns.alidns.com/dns-query",
      "https://doh.pub/dns-query"
    ],
    "fallback": [
      "https://1.1.1.1/dns-query",
      "https://8.8.8.8/dns-query",
      "tls://8.8.4.4:853"
    ],
    "fallback-filter": {
      "geoip": true,
      "geoip-code": "CN",
      "ipcidr": ["240.0.0.0/4", "0.0.0.0/32"]
    }
  };
  config['dns'] = dnsConfig;

  // ====================
  // 5. 流量嗅探
  // ====================
  config['sniffer'] = {
    "enable": true,
    "force-dns-mapping": true,
    "parse-pure-ip": true,
    "override-destination": true,
    "sniff": {
      "tls": { "ports": [443, 8443] },
      "http": { "ports": [80, 8080, 8888], "override-destination": true },
      "quic": { "ports": [443, 8443] }
    }
  };

  // ====================
  // 6. Tun 模式
  // ====================
  if (!config['tun']) config['tun'] = {};
  config['tun']['stack'] = 'mixed'; 
  config['tun']['auto-route'] = true;
  config['tun']['auto-detect-interface'] = true;
  config['tun']['mtu'] = 9000; 
  config['tun']['dns-hijack'] = ['any:53'];

  return config;
}
